<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Einkommen</title>
  </head>

  <body>
    <h1>Umstellung - Lohnberechnung 2017</h1>

    <h2> Schichtzyklus </h2>
    <p>
      Ein Schichtzüklus beginnt am
      <input id="chunk_begin_date" type="date" name="Zyklus start" min="2016-1-1" max="2017-12-31" value="2017-01-01" />
      .
    </p>
    <p>
      Der Züklus besteht aus folgenden aufeinanderfolgenden Tagen:
      <ol id="chunk">
        <li class="chunk_day">
          <select class="chunk_time">
            <option value="-1">Kein Arbeitsbeginn</option>
            <option value="0">Von 0 Uhr bis 8 Uhr</option>
            <option value="1">Von 1 Uhr bis 9 Uhr</option>
            <option value="2">Von 2 Uhr bis 10 Uhr</option>
            <option value="3">Von 3 Uhr bis 11 Uhr</option>
            <option value="4">Von 4 Uhr bis 12 Uhr</option>
            <option value="5">Von 5 Uhr bis 13 Uhr</option>
            <option value="6">Von 6 Uhr bis 14 Uhr</option>
            <option value="7">Von 7 Uhr bis 15 Uhr</option>
            <option value="8">Von 8 Uhr bis 16 Uhr</option>
            <option value="9">Von 9 Uhr bis 17 Uhr</option>
            <option value="10">Von 10 Uhr bis 18 Uhr</option>
            <option value="11">Von 11 Uhr bis 19 Uhr</option>
            <option value="12">Von 12 Uhr bis 20 Uhr</option>
            <option value="13">Von 13 Uhr bis 21 Uhr</option>
            <option value="14">Von 14 Uhr bis 22 Uhr</option>
            <option value="15">Von 15 Uhr bis 23 Uhr</option>
            <option value="16">Von 16 Uhr bis 0 Uhr am nächsten Tag</option>
            <option value="17">Von 17 Uhr bis 1 Uhr am nächsten Tag</option>
            <option value="18">Von 18 Uhr bis 2 Uhr am nächsten Tag</option>
            <option value="19">Von 19 Uhr bis 3 Uhr am nächsten Tag</option>
            <option value="20">Von 20 Uhr bis 4 Uhr am nächsten Tag</option>
            <option value="21">Von 21 Uhr bis 5 Uhr am nächsten Tag</option>
            <option value="22">Von 22 Uhr bis 6 Uhr am nächsten Tag</option>
            <option value="23">Von 23 Uhr bis 7 Uhr am nächsten Tag</option>
          </select>
          <button class="chunk_delete">&otimes;</button>
          <button class="chunk_move_up">&uArr;</button>
          <button class="chunk_move_down">&dArr;</button>
          <button class="chunk_insert_before">+&uarr;</button>
          <button class="chunk_insert_after">+&darr;</button>
        </li>
      </ol>
    </p>

    <h2> Vorheriger Vertrag </h2>
    <p>
      Das monatliches Pauschalgehalt hat
      <input id="old_blanket_wage" value="1500"></input>
      € betragen.
    </p>
    <p>
      Der Stundenlohn der den Zuschlägen zugrunde liegt hat
      <input id="old_addition_wage_rate" value="8.67"></input>
      € betragen.
    </p>
    <p>
      Sonntagszuschlag gab es
      <select id="old_sunday_factor">
        <option value="0">0%</option>
        <option value="0.05">5%</option>
        <option value="0.10">10%</option>
        <option value="0.15">15%</option>
        <option value="0.20">20%</option>
        <option value="0.25">25%</option>
        <option value="0.30">30%</option>
        <option value="0.35">35%</option>
        <option value="0.40">40%</option>
        <option value="0.45">45%</option>
        <option value="0.50" selected>50%</option>
        <option value="0.55">55%</option>
        <option value="0.60">60%</option>
        <option value="0.65">65%</option>
        <option value="0.70">70%</option>
        <option value="0.75">75%</option>
        <option value="0.80">80%</option>
        <option value="0.85">85%</option>
        <option value="0.90">90%</option>
        <option value="0.95">95%</option>
        <option value="1">100%</option>
      </select>
      .
    </p>
    <p>
      Feiertagszuschlag gab es
      <select id="old_feast_factor">
        <option value="0">0%</option>
        <option value="0.05">5%</option>
        <option value="0.10">10%</option>
        <option value="0.15">15%</option>
        <option value="0.20">20%</option>
        <option value="0.25">25%</option>
        <option value="0.30">30%</option>
        <option value="0.35">35%</option>
        <option value="0.40">40%</option>
        <option value="0.45">45%</option>
        <option value="0.50" selected>50%</option>
        <option value="0.55">55%</option>
        <option value="0.60">60%</option>
        <option value="0.65">65%</option>
        <option value="0.70">70%</option>
        <option value="0.75">75%</option>
        <option value="0.80">80%</option>
        <option value="0.85">85%</option>
        <option value="0.90">90%</option>
        <option value="0.95">95%</option>
        <option value="1">100%</option>
      </select>
      .
    </p>
    <p>
      Nachtzuschlag gab es von
      <select id="old_night_from">
        <option value="12">12 Uhr</option>
        <option value="13">13 Uhr</option>
        <option value="14">14 Uhr</option>
        <option value="15">15 Uhr</option>
        <option value="16">16 Uhr</option>
        <option value="17">17 Uhr</option>
        <option value="18">18 Uhr</option>
        <option value="19">19 Uhr</option>
        <option value="20">20 Uhr</option>
        <option value="21">21 Uhr</option>
        <option value="22">22 Uhr</option>
        <option value="23" selected>23 Uhr</option>
        <option value="24">0 Uhr</option>
      </select>
      bis
      <select id="old_night_until">
        <option value="0">0 Uhr</option>
        <option value="1">1 Uhr</option>
        <option value="2">2 Uhr</option>
        <option value="3">3 Uhr</option>
        <option value="4">4 Uhr</option>
        <option value="5">5 Uhr</option>
        <option value="6" selected>6 Uhr</option>
        <option value="7">7 Uhr</option>
        <option value="8">8 Uhr</option>
        <option value="9">9 Uhr</option>
        <option value="10">10 Uhr</option>
        <option value="11">11 Uhr</option>
        <option value="12">12 Uhr</option>
      </select>
      über
      <select id="old_night_factor">
        <option value="0">0%</option>
        <option value="0.05">5%</option>
        <option value="0.10">10%</option>
        <option value="0.15">15%</option>
        <option value="0.20">20%</option>
        <option value="0.25" selected>25%</option>
        <option value="0.30">30%</option>
        <option value="0.35">35%</option>
        <option value="0.40">40%</option>
        <option value="0.45">45%</option>
        <option value="0.50">50%</option>
        <option value="0.55">55%</option>
        <option value="0.60">60%</option>
        <option value="0.65">65%</option>
        <option value="0.70">70%</option>
        <option value="0.75">75%</option>
        <option value="0.80">80%</option>
        <option value="0.85">85%</option>
        <option value="0.90">90%</option>
        <option value="0.95">95%</option>
        <option value="1">100%</option>
      </select>
      .
    </p>

    <h2> Neuer Vertrag </h2>
    <p>
      Der Stundenlohn beträgt
      <input id="new_wage_rate" value="9.5"></input>
      €.
    </p>
    <p>
      Sonntagszuschlag gibt es
      <select id="new_sunday_factor">
        <option value="0">0%</option>
        <option value="0.05">5%</option>
        <option value="0.10">10%</option>
        <option value="0.15">15%</option>
        <option value="0.20">20%</option>
        <option value="0.25">25%</option>
        <option value="0.30">30%</option>
        <option value="0.35">35%</option>
        <option value="0.40">40%</option>
        <option value="0.45">45%</option>
        <option value="0.50" selected>50%</option>
        <option value="0.55">55%</option>
        <option value="0.60">60%</option>
        <option value="0.65">65%</option>
        <option value="0.70">70%</option>
        <option value="0.75">75%</option>
        <option value="0.80">80%</option>
        <option value="0.85">85%</option>
        <option value="0.90">90%</option>
        <option value="0.95">95%</option>
        <option value="1">100%</option>
      </select>
      .
    </p>
    <p>
      Feiertagszuschlag gibt es
      <select id="new_feast_factor">
        <option value="0">0%</option>
        <option value="0.05">5%</option>
        <option value="0.10">10%</option>
        <option value="0.15">15%</option>
        <option value="0.20">20%</option>
        <option value="0.25">25%</option>
        <option value="0.30">30%</option>
        <option value="0.35">35%</option>
        <option value="0.40">40%</option>
        <option value="0.45">45%</option>
        <option value="0.50" selected>50%</option>
        <option value="0.55">55%</option>
        <option value="0.60">60%</option>
        <option value="0.65">65%</option>
        <option value="0.70">70%</option>
        <option value="0.75">75%</option>
        <option value="0.80">80%</option>
        <option value="0.85">85%</option>
        <option value="0.90">90%</option>
        <option value="0.95">95%</option>
        <option value="1">100%</option>
      </select>
      .
    </p>
    <p>
      Nachtzuschlag gibt es von
      <select id="new_night_from">
        <option value="12">12 Uhr</option>
        <option value="13">13 Uhr</option>
        <option value="14">14 Uhr</option>
        <option value="15">15 Uhr</option>
        <option value="16">16 Uhr</option>
        <option value="17">17 Uhr</option>
        <option value="18">18 Uhr</option>
        <option value="19">19 Uhr</option>
        <option value="20">20 Uhr</option>
        <option value="21">21 Uhr</option>
        <option value="22">22 Uhr</option>
        <option value="23" selected>23 Uhr</option>
        <option value="24">0 Uhr</option>
      </select>
      bis
      <select id="new_night_until">
        <option value="0">0 Uhr</option>
        <option value="1">1 Uhr</option>
        <option value="2">2 Uhr</option>
        <option value="3">3 Uhr</option>
        <option value="4">4 Uhr</option>
        <option value="5">5 Uhr</option>
        <option value="6" selected>6 Uhr</option>
        <option value="7">7 Uhr</option>
        <option value="8">8 Uhr</option>
        <option value="9">9 Uhr</option>
        <option value="10">10 Uhr</option>
        <option value="11">11 Uhr</option>
        <option value="12">12 Uhr</option>
      </select>
      über
      <select id="new_night_factor">
        <option value="0">0%</option>
        <option value="0.05">5%</option>
        <option value="0.10">10%</option>
        <option value="0.15">15%</option>
        <option value="0.20">20%</option>
        <option value="0.25" selected>25%</option>
        <option value="0.30">30%</option>
        <option value="0.35">35%</option>
        <option value="0.40">40%</option>
        <option value="0.45">45%</option>
        <option value="0.50">50%</option>
        <option value="0.55">55%</option>
        <option value="0.60">60%</option>
        <option value="0.65">65%</option>
        <option value="0.70">70%</option>
        <option value="0.75">75%</option>
        <option value="0.80">80%</option>
        <option value="0.85">85%</option>
        <option value="0.90">90%</option>
        <option value="0.95">95%</option>
        <option value="1">100%</option>
      </select>
      .
    </p>

    <h2> Zeitraum </h2>
    <p>
      Berechnung vom
      <input id="first_date" type="date" name="Zyklus start" min="2017-1-1" max="2017-12-31" value="2017-01-01" />
      bis einschließlich
      <input id="last_date" type="date" name="Zyklus start" min="2017-1-1" max="2017-12-31" value="2017-12-31" />
      .
    </p>

    <h2> Ergebnis </h2>
    <p>
      <button id="update">UPDATE</button>
    </p>
    <p>
      Die gesamte Arbeitszeit beträgt <label id="all_working_hours"></label> Stunden.
    </p>
    <p>
      Die Arbeitszeit an Feiertagen hätte mit dem vorherigen Vertrag <label id="old_feast_working_hours"></label> Stunden betragen.
    </p>
    <p>
      Die Arbeitszeit an Feiertagen beträgt mit dem neuen Vertrag <label id="new_feast_working_hours"></label> Stunden.
    </p>
    <p>
      Die Arbeitszeit an Sonntagen hätte mit dem vorherigen Vertrag <label id="old_sunday_working_hours"></label> Stunden betragen.
    </p>
    <p>
      Die Arbeitszeit an Sonntagen beträgt mit dem neuen Vertrag <label id="new_sunday_working_hours"></label> Stunden.
    </p>
    <p>
      Die Arbeitszeit in der Nacht hätte mit dem vorherigen Vertrag <label id="old_night_working_hours"></label> Stunden betragen.
    </p>
    <p>
      Die Arbeitszeit in der Nacht beträgt mit dem neuen Vertrag <label id="new_night_working_hours"></label> Stunden.
    </p>

    <p>
      Das Einkommen hätte mit dem vorherigen Vertrag
      <label id="old_base_income"></label>
      € Basislohn +
      <label id="old_addition_income"></label>
      € Zuschlag betragen.
    </p>
    <p>
      Das Einkommen wird mit dem neuen Vertrag
      <label id="new_base_income"></label>
      € Basislohn +
      <label id="new_addition_income"></label>
      € Zuschlag betragen.
    </p>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script>

      var valid_date_begin = new Date(2016, 0,  1);
      var valid_date_end = new Date(2018, 0, 1);
      var milliseconds_per_hour = 1000 * 60 * 60;
      var hours_per_day = 24;
      var milliseconds_per_day = milliseconds_per_hour * hours_per_day;
      var valid_milliseconds = (valid_date_end.getTime() - valid_date_begin.getTime());
      var valid_days = valid_milliseconds / milliseconds_per_day;
      var days_per_week = 7;
      var sunday_date = new Date("Sun Jan 01 2017 01:00:00 GMT+0100 (CET)");
      var feast_dates = [
        new Date("Fri Jan 01 2016 01:00:00 GMT+0100 (CET)"),
        new Date("Fri Mar 25 2016 01:00:00 GMT+0100 (CET)"),
        new Date("Mon Mar 28 2016 01:00:00 GMT+0100 (CET)"),
        new Date("Sun May 01 2016 01:00:00 GMT+0100 (CET)"),
        new Date("Thu May 05 2016 01:00:00 GMT+0100 (CET)"),
        new Date("Mon May 16 2016 01:00:00 GMT+0100 (CET)"),
        new Date("Thu May 26 2016 01:00:00 GMT+0100 (CET)"),
        new Date("Mon Oct 03 2016 01:00:00 GMT+0100 (CET)"),
        new Date("Tue Nov 01 2016 01:00:00 GMT+0100 (CET)"),
        new Date("Sun Dec 25 2016 01:00:00 GMT+0100 (CET)"),
        new Date("Mon Dec 26 2016 01:00:00 GMT+0100 (CET)"),

        new Date("Sun Jan 01 2017 01:00:00 GMT+0100 (CET)"),
        new Date("Fri Apr 14 2017 01:00:00 GMT+0100 (CET)"),
        new Date("Mon Apr 17 2017 01:00:00 GMT+0100 (CET)"),
        new Date("Mon May 01 2017 01:00:00 GMT+0100 (CET)"),
        new Date("Thu May 25 2017 01:00:00 GMT+0100 (CET)"),
        new Date("Mon Jun 05 2017 01:00:00 GMT+0100 (CET)"),
        new Date("Thu Jun 15 2017 01:00:00 GMT+0100 (CET)"),
        new Date("Tue Oct 03 2017 01:00:00 GMT+0100 (CET)"),
        new Date("Tue Oct 31 2017 01:00:00 GMT+0100 (CET)"),
        new Date("Wed Nov 01 2017 01:00:00 GMT+0100 (CET)"),
        new Date("Mon Dec 25 2017 01:00:00 GMT+0100 (CET)"),
        new Date("Tue Dec 26 2017 01:00:00 GMT+0100 (CET)")
      ];

      var days_per_month = [
        31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31
      ];

      var default_shift_chunk = [

         5,  5,  5,  5, -1, -1,
         6,  6,  6,  6, -1, -1,
        13, 13, 13, 13, -1,
        21, 21, 21, 21, -1, -1, -1,
        /*
        21, 21, 21, 21, -1, -1, -1,
         5,  5,  5, 16, -1, -1,
         6,  6,  6,  6, -1, -1,
        13, 13, 16, 13, -1,
        */
      ];

      var default_night_begin_hour = 23;
      var deafult_night_end_hour = 6;

      function work_hours(shift_chunk, shift_chunk_begin_date, night_begin_hour, night_end_hour, first_date, last_date, feast_over_sunday) {

        var all_hours = 0;
        var night_hours = 0;
        var feast_hours = 0;
        var sunday_hours = 0;
        var months = 0;

        var day_date = first_date;

        var chunk_offset = (((first_date.getTime() - shift_chunk_begin_date.getTime()) / milliseconds_per_day) + (Math.ceil(valid_days / shift_chunk.length) * shift_chunk.length)) % shift_chunk.length;
        var sunday_offset = (((first_date.getTime() - sunday_date.getTime()) / milliseconds_per_day) + (Math.ceil(valid_days / days_per_week) * days_per_week)) % days_per_week;

        var end_hour = Math.max(0, shift_chunk[(chunk_offset + shift_chunk.length - 1) % shift_chunk.length] + 8 - 24);

        var next_feast_offset = 0;
        var next_feast_date = feast_dates[next_feast_offset];
        while ((next_feast_offset < feast_dates.length) && (next_feast_date.getTime() < first_date.getTime())) {
          next_feast_offset += 1;
          if (next_feast_offset < feast_dates.length) {
            next_feast_date = feast_dates[next_feast_offset];
          }
        }

        while (day_date.getTime() <= last_date.getTime()) {

          months += 1 / days_per_month[day_date.getMonth()];

          var is_feast = false;
          if ((next_feast_offset < feast_dates.length) && (day_date.getTime() == next_feast_date.getTime())) {
            is_feast = true;
            next_feast_offset += 1;
            if (next_feast_offset < feast_dates.length) {
              next_feast_date = feast_dates[next_feast_offset];
            }
          }

          all_hours += end_hour;
          night_hours += Math.min(end_hour, night_end_hour);
          if (is_feast && (feast_over_sunday || (sunday_offset != 0))) {
            feast_hours += end_hour;
          }
          if ((sunday_offset == 0) && (!feast_over_sunday || !is_feast)) {
            sunday_hours += end_hour;
          }

          var begin_hour = shift_chunk[chunk_offset];
          if (begin_hour != -1) {
            end_hour = Math.min(begin_hour + 8, 24);

            all_hours += end_hour - begin_hour;
            night_hours += 24 - Math.max(begin_hour, night_begin_hour);
            night_hours -= 24 - Math.max(end_hour, night_begin_hour);
            night_hours += Math.min(end_hour, night_end_hour);
            night_hours -= Math.min(begin_hour, night_end_hour);
            if (is_feast && (feast_over_sunday || (sunday_offset != 0))) {
              feast_hours += end_hour - begin_hour;
            }
            if ((sunday_offset == 0) && (!feast_over_sunday || !is_feast)) {
              sunday_hours += end_hour - begin_hour;
            }

            end_hour = Math.max(0, begin_hour + 8 - 24);
          } else {
            end_hour = 0;
          }

          chunk_offset = (chunk_offset + 1) % shift_chunk.length;
          sunday_offset = (sunday_offset + 1) % days_per_week;
          //alert("sunday_offset:" + sunday_offset);
          day_date = new Date(day_date.getTime() + milliseconds_per_day);
        }
        return {
          all: all_hours,
          night: night_hours,
          feast: feast_hours,
          sunday: sunday_hours,
          months: months
        };
      }

      function setup_chunk_li(li, time) {
        li.children(".chunk_time").val(time);
        li.children(".chunk_insert_before").click(function(){
          var clone = li.clone();
          setup_chunk_li(clone, -1);
          clone.insertBefore(li);
        });
        li.children(".chunk_insert_after").click(function(){
          var clone = li.clone();
          setup_chunk_li(clone, -1);
          clone.insertAfter(li);
        });
        li.children(".chunk_move_up").click(function(){
          if (!li.is(':first-child')) {
            var upper = li.prev();
            li.detach();
            li.insertBefore(upper);
          }
        });
        li.children(".chunk_move_down").click(function(){
          if (!li.is(':last-child')) {
            var lower = li.next();
            li.detach();
            li.insertAfter(lower);
          }
        });
        li.children(".chunk_delete").click(function(){
          if (li.parent().children().length > 1) {
            li.remove();
          }
        });
      }

      function setup_chunk(chunk) {
        var first = $(".chunk_day");
        var li = first;
        for (i = 0; i < chunk.length; i++) {
          var clone = li.clone();
          setup_chunk_li(clone, chunk[i]);
          clone.insertAfter(li);
          li = clone;
        }
        first.remove();
      }

      $(document).ready(function(){
        //setup_chunk_li($(".chunk_day"), -1);
        setup_chunk(default_shift_chunk);
        $("#update").click(function() {
          var chunk_days = $(".chunk_day");
          var shift_chunk = [];
          chunk_days.each(function(index) {
            shift_chunk.push(parseInt($(this).children(".chunk_time").val()))
          });
          var old_hours = work_hours(
            shift_chunk,
            new Date($("#chunk_begin_date").val()),
            parseInt($("#old_night_from").val()),
            parseInt($("#old_night_until").val()),
            new Date($("#first_date").val()),
            new Date($("#last_date").val()),
            parseFloat($("#old_feast_factor").val()) >= parseFloat($("#old_sunday_factor").val())
          );
          var new_hours = work_hours(
            shift_chunk,
            new Date($("#chunk_begin_date").val()),
            parseInt($("#new_night_from").val()),
            parseInt($("#new_night_until").val()),
            new Date($("#first_date").val()),
            new Date($("#last_date").val()),
            parseFloat($("#new_feast_factor").val()) >= parseFloat($("#new_sunday_factor").val())
          );
          $("#all_working_hours").html(old_hours.all);
          $("#old_feast_working_hours").html(old_hours.feast);
          $("#new_feast_working_hours").html(new_hours.feast);
          $("#old_sunday_working_hours").html(old_hours.sunday);
          $("#new_sunday_working_hours").html(new_hours.sunday);
          $("#old_night_working_hours").html(old_hours.night);
          $("#new_night_working_hours").html(new_hours.night);
          $("#old_base_income").html(
            Math.round(
              old_hours.months *
              parseFloat($("#old_blanket_wage").val()) *
              100
            ) / 100
          );
          $("#old_addition_income").html(
            Math.round(
              (
                old_hours.night * parseFloat($("#old_night_factor").val()) +
                old_hours.sunday * parseFloat($("#old_sunday_factor").val()) +
                old_hours.feast * parseFloat($("#old_feast_factor").val())
              ) *
              parseFloat($("#old_addition_wage_rate").val()) *
              100
            ) / 100
          );
          $("#new_base_income").html(new_hours.all * parseFloat($("#new_wage_rate").val()));
          $("#new_addition_income").html(
            Math.round(
              (
                new_hours.night * parseFloat($("#new_night_factor").val()) +
                new_hours.sunday * parseFloat($("#new_sunday_factor").val()) +
                new_hours.feast * parseFloat($("#new_feast_factor").val())
              ) *
              parseFloat($("#new_wage_rate").val()) *
              100
            ) / 100
          );
        });
      });

    </script>

  </body>

</html>
